#!/usr/bin/env ruby
# Command line utility to manage
# the zookeeper service registry
$:.unshift File.join(File.dirname(__FILE__), *%w[.. lib])

begin
  require 'rubygems'
  require 'bundler/setup'
rescue LoadError
  require 'rubygems'
end
require 'zk-service-registry'
begin
require 'zk-service-registry-config'
rescue LoadError
end

def show_service_listing
  out = ""
  service = "SERVICE".ljust(20)
  instance = "INSTANCE".ljust(25)
  data = "STATE".ljust(5)

  # headline
  out << "#{service}\t#{instance}\t#{data}\n"

  # generate service list output
  services = ZK::ServiceInstance.list_services
  services.each do |s|
    s.instances.each do |svc_inst|
      state = svc_inst.data[:state] if svc_inst.data
      out << "#{s.name.ljust(20)}\t#{svc_inst.name.ljust(25)}\t#{state.ljust(5)}\n"
    end
  end
  out
end

puts "Using ZooKeeper on #{ZK::Config::Hosts}"
if "#{ARGV[0]}".downcase.strip == '-f'
  last = "" 
  loop do
    current = show_service_listing
    if current != last then
      puts current
      last = current
    end
    sleep 1
  end
else
  puts show_service_listing
end
