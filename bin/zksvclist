#!/usr/bin/env ruby
# Command line utility to manage
# the zookeeper service registry
$:.unshift File.join(File.dirname(__FILE__), *%w[.. lib])

require 'rubygems'
require 'bundler/setup'
require 'zk-service-registry'

def show_service_listing
  service = "SERVICE".ljust(20)
  instance = "INSTANCE".ljust(25)
  data = "STATE".ljust(5)
  puts "#{service}\t#{instance}\t#{data}"
  services = ZK::ServiceInstance.list_services
  services.each do |s|
    s.instances.each do |svc_inst|
      state = svc_inst.data[:state] if svc_inst.data
      puts "#{s.name.ljust(20)}\t#{svc_inst.name.ljust(25)}\t#{state.ljust(5)}"
    end
  end
end

def service_list
  ZK::ServiceInstance.list_services.map{|s| {:name => s.name, :instances => s.instances.map{|i| i.name}} }
end

def continuous_service_list
  slc = []
  loop do
    sl = service_list
    if sl != slc
      slc = sl
      p sl
    end
    sleep 1
  end
end

if "#{ARGV[0]}".downcase.strip == '-f'
  trap('INT'){puts"\nbye!";exit}
  continuous_service_list
else
  show_service_listing
end
